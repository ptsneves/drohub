@{
    ViewData["Title"] = "MapDashboard";
    var move_to_position_box_id_prefix = "go-to-position-box-id-";
    var drone_marker_id_prefix = "device-";
}
@using DroHub.Areas.DHub.Helpers.ResourceAuthorizationHandlers
@model IEnumerable<DroHub.Areas.DHub.Models.Device>
<!-- Content Header (Page header) -->
<!-- Main content -->

<section class="content janus-section" data-janus-url='@ViewData["FrontEndJanusUrl"]' data-stun-server-url='@ViewData["FrontEndStunServerUrl"]'>
    <style>
        .control-sidebar-open {
            width: 30%;
            height: 100%;
            overflow-y: scroll;
        }

        .blinking{
            animation:blinkingText 2.0s infinite;
        }

        @@keyframes blinkingText{
            0%{     opacity: 0.0;    }
            30%{    opacity: 1.0 }
            80%{    opacity: 1.0  }
            100%{   opacity: 0.0;    }
        }

        .google-map {
            margin:0;
            padding-bottom: 109%;
            width: 100%;
            height: 100%;
        }

        .container-action-overlay {

        }

        .iradio_square-blue {
            display: none !important;
        }
        </style>
<div class="container-fluid">
    @foreach (var device in @Model) {
        var get_device_flight_start_time_url = Url.Action("GetDeviceFlightStartTime", "Devices", new {id = device.Id});
        var takeoff_action_url = Url.Action("TakeOff", "Devices", new {id = device.Id});
        var landing_action_url = Url.Action("Land", "Devices", new {id = device.Id});
        var toggle_record_video_action_url = Url.Action("RecordVideo", "Devices", new {id = device.Id});
        var take_picture_action_url = Url.Action("TakePicture", "Devices", new {id = device.Id});
        var return_to_home_action_url = Url.Action("ReturnToHome", "Devices", new {id = device.Id});
        var move_to_position_action_url = Url.Action("MoveToPosition", "Devices", new {id = device.Id});
        var move_to_position_box_id = move_to_position_box_id_prefix + device.Id;
        var radio_signals_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(null));
        var position_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(null));
        var battery_level_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(null));
        var flying_state_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(null));
        var video_state_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(new DroneLiveVideoStateResult(){State = DroneLiveVideoState.INVALID_CONDITION}));

        var ColourValues = new[]
        {
            "3c8dbc", "00c0ef", "dd4b39", "f39c12", "00a65a"
        };

        <div class="box" style="border-top: 4px solid #@ColourValues[device.Id % ColourValues.Length]" id="devices-box-@device.Name">
            <div class="box-header with-border">
                <h3 class="box-title">
                    <i class="fas fa-drone-alt text-muted blinking flying-state-text" data-renderer="renderPlaneIcon" data-serial="@device.SerialNumber" data-telemetry='@flying_state_initial'></i>
                    @device.Name</h3>
                <div class="box-tools pull-right">
                    <span class="label label-primary" id="status-@device.Id"></span>
                    <span class="label label-primary" id="curres-@device.Id"></span>
                    <span class="label label-info" id="curbitrate-@device.Id"></span>
                    <span class="label label-info" id="datarecv-@device.Id"></span>
                    <a href="#" class="btn btn-box-tool-drohub in-relocatable-box-move-down"><i class="fa fa-arrow-alt-down"></i></a>
                    <a href="#" class="btn btn-box-tool-drohub in-relocatable-box-move-up"><i class="fa fa-arrow-alt-up"></i></a>
                    <a href="@Url.Action("Edit", "Devices", new {id = device.Id})" class="btn btn-box-tool-drohub"><i class="fa fa-cog"></i></a>
                    <button type="button" data-widget="collapse" class="btn btn-box-tool-drohub"><i class="fa fa-minus"></i></button>
                </div>
            </div>
            <div class="box-body">
                <div class="box" id="@move_to_position_box_id" style="display: none">
                    <div class="box-header with-border">
                        <h3 class="box-title">Move To Position</h3>
                        <div class="box-tools pull-right">
                            <button type="button" data-widget="collapse" class="btn btn-box-tool"><i class="fa fa-minus"></i></button>
                        </div>
                    </div>
                    <div class="box-body">
                        <iframe name="fake-submit" style="display:none;"></iframe>
                        <form method="get" action="@move_to_position_action_url" target="fake-submit">
                            <input type="hidden" name="Id" class="form-control" value="@device.Id">
                            <input type="text" name="Longitude" class="form-control" placeholder="Longitude in decimal">
                            <input type="text" name="Latitude" class="form-control" placeholder="Latitude in decimal">
                            <input type="text" name="Altitude" class="form-control" placeholder="Altitude in decimal">
                            <input type="text" name="Heading" class="form-control" placeholder="Heading in degrees">
                            <button type="submit" name="goto-position" class="btn pull-right">Go!</button>
                        </form>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 small-gutter map-container">
                        <span class="position-text marker main-marker" data-renderer="renderMapMarker" data-serial="@device.SerialNumber" data-device-type="drone" data-marker-svg-path="images/assets/device-pin/device-pin-red.svg" data-telemetry='@position_initial'></span>
                        <div class="google-map" data-serial="@device.SerialNumber"></div>
                        <select class="js-example-basic-single " style="width: 100%;">
                            <option title="Move to Position">Move To Position</option>
                        </select>
                    </div>
                    <div class="col-md-8 small-gutter">
                        <div id="box-body-@device.Id">
                            <div class="webrtc-video" data-serial="@device.SerialNumber">
                                <div class="embed-responsive embed-responsive-16by9" id="stream-@device.Id">
                                    <div class="device-video-overlay device-video-overlay-animation container ">
                                        <div class="video-overlay-top row vertical-align">
                                            <div class="col-md-11" style="width: 100%;text-align: left;">
                                                <div class="minimum-size" style="padding-right: 3%">
                                                    <i class="fad radio-signal" data-renderer="renderRadioSignalIcon" data-serial="@device.SerialNumber" data-telemetry='@radio_signals_initial'></i>
                                                    <i class="battery-level fa" data-renderer="renderBatteryLevelIcon" data-serial="@device.SerialNumber" data-telemetry='@battery_level_initial'>
                                                        <span class=" battery-level fa" data-renderer="renderBatteryLevel" data-serial="@device.SerialNumber" data-telemetry='@battery_level_initial'>No data</span>
                                                    </i>
                                                </div>
                                                @* <div class="minimum-size" style="padding-right: 3%; padding-left: 3%;"> *@
                                                @*     <img src="/images/assets/video-info-satelite.svg"> *@
                                                @*     <span class="satellite-count" data-renderer="renderSatelliteCount" data-serial="@device.SerialNumber" data-telemetry='null'>-1</span> *@
                                                @*     <img src="/images/assets/video-info-controlsignal-good.svg"> *@
                                                @*     <img src="/images/assets/video-info-height.svg"> *@
                                                @*     <span class="position" data-renderer="renderAltitude" data-serial="@device.SerialNumber" data-telemetry='@position_initial'>-1</span> *@
                                                @* </div> *@
                                                @* <i>|</i> *@
                                                <div class="minimum-size" style="padding-right: 3%; padding-left: 3%;">
                                                    <span class="  " data-renderer="renderFlightTimeText" data-url="@get_device_flight_start_time_url" data-serial="@device.SerialNumber" data-telemetry='null'>00:00</span>
                                                    <i>-</i>
                                                    <span class="flying-state-text" data-renderer="renderFlyingState" data-serial="@device.SerialNumber" data-telemetry='@flying_state_initial'>FlightState</span>
                                                </div>
                                            </div>
                                            @* <div class="container-action-overlay col-md-4" style="width: 100%; text-align: center;"> *@
                                            @* *@
                                            @*     <button class="btn-transparent-bg" data-url="@takeoff_action_url" data-toggle="ajax-request" title="Take off this device"> *@
                                            @*     <i class="fas fa-plane-departure"></i> *@
                                            @*     </button> *@
                                            @*     <button class="btn-transparent-bg" data-url="@landing_action_url" data-toggle="ajax-request" title="Land this device"> *@
                                            @*         <i class="fas fa-plane-arrival"></i> *@
                                            @*     </button> *@
                                            @*     <button class="btn-transparent-bg" data-toggle="ajax-request" data-url="@return_to_home_action_url"> *@
                                            @*         <i class="fas fa-home"></i> *@
                                            @*     </button> *@
                                            @* </div> *@
                                            <div class="col-md-1 no-side-padding" style="text-align: right;">
                                                @* <button class="btn-transparent-bg" data-toggle="ajax-request" data-url="@return_to_home_action_url">
                                                            <i class="far fa-external-link-alt"></i>
                                                        </button> *@

                                                <button class="btn-transparent-bg " data-serial="@device.SerialNumber" data-toggle="video-mute">
                                                    <i class="fas fa-microphone-slash"></i>
                                                </button>
                                                <button class="btn-transparent-bg " data-serial="@device.SerialNumber" data-toggle="video-fullscreen">
                                                    <i class="fas fa-compress"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="video-overlay-bottom row row-no-padding vertical-align">
                                            <div class="col-md-3 max-width">
                                                @* <div class="video-overlay-rth column-vertical-center no-side-padding"> *@
                                                @*     <form method="post" action="@toggle_record_video_action_url" data-toggle="ajax-request" autocomplete="off"> *@
                                                @*         <input type="radio" name="@nameof(DroneRecordVideoRequest.ActionType)" value="@ActionType.START" checked> *@
                                                @*         <input type="radio" name="@nameof(DroneRecordVideoRequest.ActionType)" value="@ActionType.STOP"> *@
                                                @*         <button type="submit" class="btn-transparent-bg video-overlay-record-icon" title="Toggle Video Recording"> *@
                                                @*             <img class="fit-to-parent" src="/images/assets/video-btn-home.svg"> *@
                                                @*         </button> *@
                                                @*     </form> *@
                                                @* </div> *@
                                            </div>
                                            <div class="col-md-3 max-width"></div>
                                            <div class="col-md-3 max-width"></div>
                                            <div class="col-md-3 max-width">
                                                <div class="video-overlay-record-rectangle">
                                                    <div class="col-md-6 column-vertical-center no-side-padding">
                                                        <form method="post" action="@take_picture_action_url" data-toggle="ajax-request" autocomplete="off">
                                                            <input type="radio" name="@nameof(DroneTakePictureRequest.ActionType)" value="@ActionType.START" checked>
                                                            <input type="radio" name="@nameof(DroneTakePictureRequest.ActionType)" value="@ActionType.STOP">
                                                            <button type="submit" class="btn-transparent-bg video-overlay-photo-icon" title="Take Picture">
                                                                <img class="fit-to-parent" src="/images/assets/video-btn-camera.svg">
                                                            </button>
                                                        </form>
                                                    </div>
                                                    <div class="col-md-6 column-vertical-center  no-side-padding">
                                                        <form method="post" action="@toggle_record_video_action_url" data-toggle="ajax-request" autocomplete="off">
                                                            <input type="radio" name="@nameof(DroneRecordVideoRequest.ActionType)" value="@ActionType.START" checked>
                                                            <input type="radio" name="@nameof(DroneRecordVideoRequest.ActionType)" value="@ActionType.STOP">
                                                            <button type="submit" class="btn-transparent-bg video-overlay-record-icon" title="Toggle Video Recording">
                                                                <img class="fit-to-parent" src="/images/assets/video-btn-record.svg">
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            @* <div class="row video-overlay-centered">
                                                <a href="#" data-toggle="drone-control-box" class="btn-transparent-bg link-unstyled video-overlay-controls-toggle plus-right" data-serial="@device.SerialNumber" >
                                                        Open Controls
                                                </a>
                                            </div> *@
                                        </div>
                                    </div>
                                    <audio class="device-audio" data-room-id="@device.Id" data-serial="@device.SerialNumber"></audio>
                                    <video
                                           class="rounded centered embed-responsive-item controls janus-video device-video"
                                           data-telemetry='@video_state_initial'
                                           data-renderer="renderLiveVideo"
                                           data-render-state="stopped"
                                           data-room-id="@device.Id"
                                           data-serial="@device.SerialNumber"
                                           autoplay playsinline>
                                    </video>
                                </div>
                                <div class="box collapsed-box drone-control-box" data-serial="@device.SerialNumber">
                                    <div class="box-body">
                                        <div class="row">
                                            <div class="col-md-3">1</div>
                                            <div class="col-md-3">1</div>
                                            <div class="col-md-3">1</div>
                                            <div class="col-md-3">1</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
    <div class="modal fade" id="modal-move-to-position">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Go to Position</h4>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                             <div class="col-md-4">
                                Latitude
                            </div>
                            <div class="col-md-4" id="modal-latitude-value">
                                Value
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-4">
                                Longitude
                            </div>
                            <div class="col-md-4" id="modal-longitude-value">
                                Value
                            </div>
                        </div>
                        <div class="row">
                            @{
                                var devices_select_list = new SelectList(Model, "Id", "Name");
                            }
                            <div class="col-md-4">
                                Select which device should go to Position.
                            </div>
                            <div class="col-md-4">
                                <select asp-items="devices_select_list" id="move-to-position-device-select"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="onGoToPositionDeviceSelected()" data-dismiss="modal" >
                    Select
                    </button>
                </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->

</section>
@section Scripts {
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js" ></script>
    <script type="text/javascript" src="~/js/janus.js" ></script>
    <script type="text/javascript" src="~/js/videoroomtest.js"></script>
    <script src='https://maps.googleapis.com/maps/api/js?@ViewData["GoogleAPIKey"]'></script>
    <script type="text/javascript" src="~/js/dashboard.js" ></script>
    <script>

    function onGoToPositionDeviceSelected() {
        let selected_device_serial = $('#move-to-position-device-select').val();
        let device_box = $(`#@move_to_position_box_id_prefix${selected_device_serial}`)
        let lat = $('#modal-latitude-value').text();
        let lng = $('#modal-longitude-value').text();
        device_box.attr('style', 'display:initial')
        device_box.find("input[name='Longitude']").val(lng);
        device_box.find("input[name='Latitude']").val(lat);
        device_box.find("input[name='Altitude']").focus();
    }
    </script>
}

@section head {
    <!-- iCheck -->
    <link rel="stylesheet" href="~/AdminLTE/plugins/iCheck/square/blue.css">
}
