@{
    @using Newtonsoft.Json;
    ViewData["Title"] = "MapDashboard";
    var move_to_position_box_id_prefix = "go-to-position-box-id-";
    var drone_marker_id_prefix = "device-";
}
@model IEnumerable<DroHub.Areas.DHub.Models.Device>
<!-- Content Header (Page header) -->
<!-- Main content -->

<section class="content janus-section" data-janus-url='@ViewData["FrontEndJanusUrl"]' data-stun-server-url='@ViewData["FrontEndStunServerUrl"]'>
    <style>
        .control-sidebar-open {
            width: 30%;
            height: 100%;
            overflow-y: scroll;
        }

        .gm-style .gm-style-iw {
            color: #FFFFFF;
            background-color: #3C61AD !important;
            top: 0 !important;
            left: 0 !important;
            padding-top: 10px;
            display: block !important;
        }

        .gm-style .gm-style-iw #google-popup p{
            padding: 10px;
        }
        /*style the link*/
        .gm-style div div div div div div div div a {
            color: #f1f1f1;
            font-weight: bold;
        }

        .blinking{
            animation:blinkingText 1.5s infinite;
        }

        @@keyframes blinkingText{
            0%{     opacity: 1.0;    }
            30%{    color: transparent; }
            70%{    color: transparent;  }
            100%{   opacity: 1.0;    }
        }

        </style>

    <div class="container-fluid">
            <input type="text" name="drone_search" class="form-control" placeholder="Search device by name or serial...">
            @foreach(var device in @Model)
            {
                var takeoff_action_url = Url.Action("TakeOff", "Devices", new {id = device.Id});
                var landing_action_url = Url.Action("Land", "Devices", new {id = device.Id});
                var return_to_home_action_url = Url.Action("ReturnToHome", "Devices", new {id = device.Id});
                var move_to_position_action_url = Url.Action("MoveToPosition", "Devices", new {id = device.Id});
                var move_to_position_box_id = move_to_position_box_id_prefix + device.Id;
                var radio_signals_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(device.radio_signals?.FirstOrDefault()) as String);
                var position_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(device.positions?.FirstOrDefault()) as String);
                var battery_level_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(device.battery_levels?.FirstOrDefault()) as String);
                var flying_state_initial = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(device.flying_states?.FirstOrDefault()) as String);

                <div class="box" id="devices-box-@device.Name">
                    <div class="box-header with-border">
                        <h3 class="box-title">
                            <i class="fa fa-paper-plane text-muted blinking telemetry-single-data flying-state-text" data-renderer="renderPlaneIcon" data-serial="@device.SerialNumber" data-telemetry='@flying_state_initial'></i>
                            @device.Name</h3>
                        <div class="box-tools pull-right">
                            <button type="button" class="btn btn-box-tool map-marker-action-button" title="Center map in device" data-serial='@device.SerialNumber' data-device-type="drone" data-toggle="centerMapOnDevice"><i class="fa fa-map"></i></button>
                            <button type="button" data-widget="collapse" class="btn btn-box-tool"><i class="fa fa-minus"></i></button>
                        </div>
                    </div>
                    <div class="box-body">
                        <div class="box box-solid">
                            <ul class="nav nav-pills nav-stacked">
                                <li>
                                        <i class="fa fa-info"></i>
                                        Device State
                                        <span class="label label-default pull-right telemetry-single-data flying-state-text" data-renderer="renderFlyingState" data-serial="@device.SerialNumber" data-telemetry='@flying_state_initial'>No data</span>
                                </li>
                                <li>
                                        <i class="fa fa-signal"></i>
                                        Telemetry Signal
                                        <span class="label label-default pull-right telemetry-single-data radio-signal-text" data-renderer="renderRadioSignal" data-serial="@device.SerialNumber" data-telemetry='@radio_signals_initial'>
                                            No data
                                        </span>
                                </li>
                                <li>
                                        <i class="fa fa-battery"></i>
                                        Battery
                                        <span class="label label-default pull-right telemetry-single-data battery-level-text" data-renderer="renderBatteryLevel" data-serial="@device.SerialNumber" data-telemetry='@battery_level_initial'>No data</span>
                                </li>
                                <li>
                                        <i class="fa fa-arrows-alt"></i>
                                        GPS Signal
                                        <span class="label label-default pull-right ">No data</span>
                                </li>
                                <li>
                                        <i class="fa fa-map-marker"></i>
                                        Position
                                        <span class="label label-primary pull-right telemetry-single-data position-text" data-device-type="drone" data-renderer="renderPositionText" data-serial="@device.SerialNumber" data-telemetry='@position_initial'>No data</span>
                                </li>
                            </ul>

                            <div class="embed-responsive embed-responsive-16by9">
                                <div class="google-map embed-responsive-item" data-serial="@device.SerialNumber" style="border: 1px solid black"></div>
                            </div>
                        </div>

                        <div class="box box-solid">
                            <button data-url="@takeoff_action_url" data-toggle="ajax-request" class="btn btn-danger" title="Take off this device">
                                TakeOff
                            </button>
                            <button data-url="@landing_action_url" data-toggle="ajax-request" class="btn btn-danger" title="Land this device">
                                Land
                            </button>
                            <button type='button btn btn-danger' data-toggle="ajax-request" data-url="@return_to_home_action_url" class="btn btn-danger">
                                Return to Home
                            </button>

                            <div class="box" id="@move_to_position_box_id" style="display: none">
                                <div class="box-header with-border">
                                    <h3 class="box-title">Move To Position</h3>
                                    <div class="box-tools pull-right">
                                        <button type="button" data-widget="collapse" class="btn btn-box-tool"><i class="fa fa-minus"></i></button>
                                    </div>
                                </div>
                                <div class="box-body">
                                    <iframe name="fake-submit" style="display:none;"></iframe>
                                    <form method="get" action="@move_to_position_action_url" target="fake-submit">
                                        <input type="hidden" name="Id" class="form-control" value="@device.Id">
                                        <input type="text" name="Longitude" class="form-control" placeholder="Longitude in decimal">
                                        <input type="text" name="Latitude" class="form-control" placeholder="Latitude in decimal">
                                        <input type="text" name="Altitude" class="form-control" placeholder="Altitude in decimal">
                                        <input type="text" name="Heading" class="form-control" placeholder="Heading in degrees">
                                        <button type="submit" name="goto-position" class="btn pull-right">Go!</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="box collapsed-box" id="box-stream-@device.Id">
                            <div class="box-header with-border">
                                <h3 class="box-title">
                                    Stream
                                </h3>
                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool video-play" device-id="@device.Id"><i class="fa fa-play"></i></button>
                                    <button type="button" data-widget="collapse" class="btn btn-box-tool"><i class="fa fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="box-body" id="box-body-@device.Id">
                                <div class="webrtc-video hide">
                                    <div class="embed-responsive embed-responsive-16by9" id="stream-@device.Id">
                                        <video class="rounded centered embed-responsive-item controls" id="remotevideo-@device.Id" autoplay playsinline>
                                        </video>
                                    </div>
                                    <div class="box-tools pull-right box-solid">
                                        <span class="label label-primary" id="status-@device.Id"></span>
                                        <span class="label label-primary" id="curres-@device.Id"></span>
                                        <span class="label label-info" id="curbitrate-@device.Id"></span>
                                        <span class="label label-info" id="datarecv-@device.Id"></span>
                                    </div>
                                </div>
                                <div class='no-video-placeholder'>
                                    <h4>
                                        Video is not started. Press play to Start.
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

    </div>
    <div class="modal fade" id="modal-move-to-position">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Go to Position</h4>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                             <div class="col-md-4">
                                Latitude
                            </div>
                            <div class="col-md-4" id="modal-latitude-value">
                                Value
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-4">
                                Longitude
                            </div>
                            <div class="col-md-4" id="modal-longitude-value">
                                Value
                            </div>
                        </div>
                        <div class="row">
                            @{
                                var devices_select_list = new SelectList(Model, "Id", "Name");
                            }
                            <div class="col-md-4">
                                Select which device should go to Position.
                            </div>
                            <div class="col-md-4">
                                <select asp-items="devices_select_list" id="move-to-position-device-select"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="onGoToPositionDeviceSelected()" data-dismiss="modal" >
                    Select
                    </button>
                </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->


    <script src="/lib/dropbox-sdk/Dropbox-sdk.min.js"></script>
</section>
@section Scripts {
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js" ></script>
    <script type="text/javascript" src="~/js/janus.js" ></script>
    <script type="text/javascript" src="~/js/streamingtest.js"></script>
    <script src='https://maps.googleapis.com/maps/api/js?@ViewData["GoogleAPIKey"]'></script>
    <script src="/lib/signalr/dist/browser/signalr.js"></script>
    <script type="text/javascript" src="~/js/dashboard.js" ></script>
    <script>

    function onGoToPositionDeviceSelected() {
        let selected_device_serial = $('#move-to-position-device-select').val();
        let device_box = $(`#@move_to_position_box_id_prefix${selected_device_serial}`)
        let lat = $('#modal-latitude-value').text();
        let lng = $('#modal-longitude-value').text();
        device_box.attr('style', 'display:initial')
        device_box.find("input[name='Longitude']").val(lng);
        device_box.find("input[name='Latitude']").val(lat);
        device_box.find("input[name='Altitude']").focus();
    }
    </script>
}